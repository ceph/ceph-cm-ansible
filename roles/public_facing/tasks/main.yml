---
## Common tasks

# Most of our public-facing hosts are running Ubuntu.
# use_ufw defaults to false but is overridden in inventory host_vars
- import_tasks: ufw.yml
  when: use_ufw == true
  tags:
    - always

- import_tasks: fail2ban.yml
  tags:
    - always
  when: use_fail2ban == true

- name: Disable password authentication
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    state: present
  notify: restart sshd
  tags: ssh_config

- name: Remove SHA1 MACs from ssh config
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^MACs"
    line: "MACs hmac-sha2-512,hmac-sha2-256"
    insertafter: EOF
    state: present
  notify: restart sshd 
  tags: ssh_config 

## Individual host tasks

# local_action in the task after this causes 'ansible_host' to change to 'localhost'
# we set a temporary variable here to search for in the local_action task
- set_fact:
    target_host: "{{ ansible_host }}"

- name: Check for host-specific playbooks
  local_action: "stat path=roles/public_facing/tasks/{{ target_host }}.yml"
  register: host_playbook

- name: Include any host-specific playbooks if present
  include_tasks: "{{ ansible_host }}.yml"
  when: host_playbook.stat.exists
