# 0) Safety defaults
- set_fact:
    managed_admin_users: "{{ managed_admin_users | default([]) }}"
    users: "{{ users | default([]) }}"

# 1) De-duplicate lab_users by name (keeps the first occurrence)
- name: De-dup lab_users by name
  set_fact:
    _lab_users_unique: >-
      {{
        (lab_users | groupby('name'))
        | map('last') | map('first') | list
      }}

# 2) Build admin names list (supports list-of-dicts OR list-of-strings)
- name: Build _admin_names safely
  set_fact:
    _admin_names: >-
      {{
        (
          (managed_admin_users | length > 0) and ((managed_admin_users | first) is mapping)
        )
        | ternary(
            managed_admin_users | map(attribute='name') | list,
            managed_admin_users | list
          )
      }}

# 3) managed_users = lab_users_unique MINUS admins
- name: Recompute managed_users
  set_fact:
    managed_users: "{{ _lab_users_unique | rejectattr('name','in', _admin_names) | list }}"

# 4) Optional allowlist (only if users provided)
- name: Apply allowlist "users"
  when: users | length > 0
  set_fact:
    managed_users: "{{ managed_users | selectattr('name','in', users) | list }}"
    managed_admin_users: >-
      {{
        (
          (managed_admin_users | length > 0) and ((managed_admin_users | first) is mapping)
        )
        | ternary(
            managed_admin_users | selectattr('name','in', users) | list,
            (managed_admin_users | select('in', users) | list)
          )
      }}
