name: tests

on: [push, pull_request]

jobs:
  syntax-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install ansible
      run: |
        sudo apt-get update
        sudo apt-get purge ansible
        sudo apt-get install python3-setuptools
        pip3 install ansible --user
    - name: ansible-playbook syntax check
      run: |
        export PATH=$PATH:$HOME/.local/bin
        sed -i /^vault_password_file/d ansible.cfg
        ansible-playbook -i localhost, cephlab.yml --syntax-check
  ansible-lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@03bb6152f4f691b9d64579a1bd791904a083c452
    - name: Install ansible-lint
      run: |
        sudo apt-get update
        sudo apt-get purge ansible
        sudo apt-get install python3-setuptools
        # This pinned ansible version should match teuthology's
        # requirements.txt.
        # And we choose an ansible-lint version to be compatible with this
        # Ansible version.
        pip3 install ansible-core==2.17.7 ansible-lint --user
    - name: Run ansible-lint
      run: |
        export PATH=$PATH:$HOME/.local/bin
        sed -i /^vault_password_file/d ansible.cfg
        ansible-lint -v roles/*
