### This playbook configures a braggi host to be a Jenkins slave.

- hosts:
    - braggi
    - incerta
    - irvingi
    - adami
    - toko
    - bath
  become: true
  tasks:

# CentOS 9 on these nodes likes to flip around which disk is sda and which is sdb.
# We pick the ~400GB disk by choosing the one < 500 GiB.
  - set_fact:
      jenkins_slave_mount_point: /home/jenkins-build
      disk_flip_host: "{{ ('braggi' in ansible_hostname) or ('adami' in ansible_hostname) }}"
  
  - name: Check if /dev/sda is the 400GB disk (braggi/adami)
    parted:
      device: "/dev/sda"
      unit: GiB
    register: sda_parted
    when: disk_flip_host
  
  - name: Check if /dev/sdb is the 400GB disk (braggi/adami)
    parted:
      device: "/dev/sdb"
      unit: GiB
    register: sdb_parted
    when: disk_flip_host
  
  - name: Set mount_point for jenkins-build (braggi/adami)
    set_fact:
      mount_point: "{{ jenkins_slave_mount_point }}"
    when: disk_flip_host
  
  - name: Select 400GB disk as /dev/sda (braggi/adami)
    set_fact:
      disk: /dev/sda
    when:
      - disk_flip_host
      - sda_parted.disk.size is defined
      - sda_parted.disk.size < 500
  
  - name: Select 400GB disk as /dev/sdb (braggi/adami)
    set_fact:
      disk: /dev/sdb
    when:
      - disk_flip_host
      - sdb_parted.disk.size is defined
      - sdb_parted.disk.size < 500

  - set_fact:
      disk: /dev/nvme0n1
      mount_point: /home/jenkins-build
    when: ansible_hostname is search("incerta|toko")

# Setting the mountpoint to libvirt/images on irvinigi because I'm adding two
# right now as CentOS7 Vagrant builders.
  - set_fact:
      disk: /dev/sdc
      mount_point: /var/lib/libvirt/images
    when: '"irvingi" in ansible_hostname'

  - name: "Create {{ mount_point }} home dir"
    file:
      path: "{{ mount_point }}"
      state: directory

  - name: Install xfsprogs (Ubuntu)
    package:
      name: xfsprogs
      state: latest
    when: ansible_os_family == "Debian"

  - name: Unmount (ignore if not mounted)
    mount:
      path: "{{ mount_point }}"
      state: unmounted
    ignore_errors: true

  - name: Zap disk
    command: "sgdisk -Z {{ disk }}"

  - name: Configure disk
    filesystem:
      fstype: xfs
      dev: "{{ disk }}"

  - name: Get XFS UUID
    command: "blkid -s UUID -o value {{ disk }}"
    register: xfs_uuid
    changed_when: false

  - name: Mount disk (fstab uses UUID)
    mount:
      path: "{{ mount_point }}"
      src: "UUID={{ xfs_uuid.stdout }}"
      fstype: xfs
      state: mounted
